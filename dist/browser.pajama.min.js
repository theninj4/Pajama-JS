(function(e){var t=null;function n(e){for(var t in e){this[t]=e[t]}}function r(e,t,r,o){if(e[t]==undefined){e[t]=""}if(e[t]instanceof Function){var a=function(n){e[t].call(e,n)};o.garbage.push(function(){o.removeEvent(r,a)});o.addEvent(r,a);return}if(!Object.getOwnPropertyDescriptor(e,t).hasOwnProperty("get")){var i=e[t];var s=[];var l;Object.defineProperty(e,t,{get:function(){return i},set:function(r){if(r instanceof n){l=r.element;var a=function(){r.element.setAttr(r.attr,i)};var c=function(n){if(r.element.getAttr(r.attr)!=i){e[t]=r.element.getAttr(r.attr)}};if(r.attr instanceof Function){a=r.attr;c=function(){}}o.garbage.push(function(){l=null;var n=s.indexOf(a);if(n>=0){s.splice(n,1)}r.element.removeEvent("change",c);r.element.removeEvent("keyup",c);Object.defineProperty(e,t,{value:i,writable:true})});s.push(a);r.element.addEvent("change",c);r.element.addEvent("keyup",c);r.element.setAttr(r.attr,i)}else{i=r;for(var u=0;u<s.length;u++){s[u].call(o,i)}}},enumerable:true})}e[t]=new n({element:o,attr:r})}function o(e,t,r,o){if(!e.hasOwnProperty(t)){e[t]=[]}if(!Object.getOwnPropertyDescriptor(e,t).hasOwnProperty("get")){var a=e[t];var i=[];Object.defineProperty(e,t,{get:function(){var n=a.concat([]);Object.defineProperty(n,"pop",{value:function(){var e=a.pop();for(var t=0;t<i.length;t++){var n=i[t].element.getNodes();n[n.length-1].remove()}return e}});Object.defineProperty(n,"push",{value:function(){var e=a.push.apply(a,Array.prototype.slice.call(arguments));for(var t=0;t<i.length;t++){var n=i[t];var r=n.func.call({},arguments[0]);if(r)n.element.append(r)}return e}});Object.defineProperty(n,"reverse",{value:function(){var n=a.reverse();e[t]=a;return n}});Object.defineProperty(n,"shift",{value:function(){var e=a.shift();for(var t=0;t<i.length;t++){var n=i[t].element.getNodes();n[0].remove()}return e}});Object.defineProperty(n,"sort",{value:function(){var n=a.sort.apply(a,Array.prototype.slice.call(arguments));e[t]=a;return n}});Object.defineProperty(n,"splice",{value:function(){var n=a.splice.apply(a,Array.prototype.slice.call(arguments));e[t]=a;return n}});Object.defineProperty(n,"unshift",{value:function(){var e=a.unshift.apply(a,Array.prototype.slice.call(arguments));for(var t=0;t<i.length;t++){var n=i[t];var r=n.func.call({},arguments[0]);if(r)n.element.prepend(r)}return e}});return n},set:function(r){if(r instanceof n){i.push({element:r.element,func:r.func})}else{a=r}for(var o=0;o<i.length;o++){var s=i[o];s.element.clear();for(var l in a){var c=s.func.call({},e[t][l]);if(c)s.element.append(c)}}},enumerable:true})}e[t]=new n({element:r,func:o})}var a=0;function i(e){if(!e)e={};if(!e.tag)e.tag="div";var n;var s=document.createElement(e.tag);var l=this;l.dom=s;l.eventList=[];l.garbage=[];s._view=l;l.uuid=a++;l.prepend=function(e){var n=e;if(!(n instanceof Array))n=Array.prototype.slice.call(arguments);for(var r=0;r<n.length;r++){var o=n[r];if(o instanceof i){l.dom.insertBefore(o.dom,l.dom.firstChild);if(t)l.fireEvent("PjsChange",{type:"prepend",parent:l.uuid,markup:o.toMarkup(true)})}else{l.prepend(new i(o))}}};l.append=function(e){var n=e;if(!(n instanceof Array))n=Array.prototype.slice.call(arguments);for(var r=0;r<n.length;r++){var o=n[r];if(o instanceof i){l.dom.appendChild(o.dom);if(t)l.fireEvent("PjsChange",{type:"append",parent:l.uuid,markup:o.toMarkup(true)})}else{l.append(new i(o))}}};l.remove=function(e){if(t&&!e){l.fireEvent("PjsChange",{type:"remove",parent:l.dom.parentNode._view.uuid,child:l.uuid})}l.dom.parentNode.removeChild(l.dom);l.recycle()};l.recycle=function(){var e,t=l.getNodes();for(e=0;e<t.length;e++){t[e].recycle()}for(e=0;e<l.garbage.length;e++){l.garbage[e]()}};l.addClass=function(e){if(e!==""){l.dom.className=l.dom.className||"";l.dom.className+=" "+e}};l.removeClass=function(e){if(e!==""){l.dom.className=(" "+l.dom.className+" ").replace(" "+e+" ","")}};l.hasClass=function(e){return(" "+l.dom.className+" ").indexOf(" "+e+" ")!=-1};l.setAttr=function(e,n){if(typeof e=="string"&&l.dom[e]!=n){l.dom[e]=n;l.dom.setAttribute(e,n);if(t)l.fireEvent("PjsChange",{type:"attr",id:l.uuid,attr:e,value:n})}};l.getAttr=function(e){return l.dom[e]};l.addEvent=function(e,t){l.dom.addEventListener(e,t);if(l.eventList.indexOf(e)==-1)l.eventList.push(e)};l.removeEvent=function(e,t){l.dom.removeEventListener(e,t)};l.setValue=function(e){if(["input","select"].indexOf(l.dom.tagName.toLowerCase())!=-1){l.dom.value=e}else{l.dom.innerHTML=e}};l.getValue=function(){return l.dom.value||l.dom.innerHTML};l.clear=function(){var e=l.dom.childNodes.length;for(var n=0;n<e;n++){l.dom.childNodes[0]._view.remove(true)}if(t)l.fireEvent("PjsChange",{type:"clear",parent:l.uuid});return l};l.fireEvent=function(e,t){var n=document.createEvent("HTMLEvents");n.initEvent(e,true,true);n.detail=t;l.dom.dispatchEvent(n);return l};l.getNodes=function(){var e=[];for(var t=0;t<l.dom.childNodes.length;t++){var n=l.dom.childNodes[t];if(n._view){e.push(n._view)}else{var r=new i;r.dom=n;e.push(r)}}return e};l.getByUuid=function(e){if(l.uuid==e)return l;for(var t=0;t<l.dom.childNodes.length;t++){var n=l.dom.childNodes[t]._view.getByUuid(e);if(n)return n}return null};l.toMarkup=function(e){var t="<"+l.dom.tagName;for(var n in l.dom){if(["tagName","elemCount","classList","addEventListener","appendChild","removeChild","childNodes","dispatchEvent","_view","parentNode"].indexOf(n)<0){if(typeof l.dom[n]=="string"||typeof l.dom[n]=="number"){t+=" "+n+'="'+l.dom[n]+'"'}}}if(e){t+=" id='"+l.uuid+"'";for(var r in l.eventList){var o=l.eventList[r];t+=" on"+o+"=\"dispatch('"+l.uuid+"', '"+o+"', event)\" "}}t+=">";if(l.dom.innerHTML){t+=l.dom.innerHTML}for(var a in l.dom.childNodes){t+=l.dom.childNodes[a]._view.toMarkup(e)}return t+"</"+l.dom.tagName+">"};if(e.classes){for(n=0;n<e.classes.length;n++){l.addClass(e.classes[n])}}if(e.contains){var c=e.contains;if(c instanceof Object&&Object.keys(c).length==1&&e.forEach){var u=Object.keys(c)[0];o(c[u],u,l,e.forEach)}else if(c instanceof Object&&Object.keys(c).length==1&&e.usingView){var u=Object.keys(c)[0];o(c[u],u,l,function(t){p.view[e.usingView].apply(l,[t])})}else{if(!(c instanceof Array))c=[c];for(n=0;n<c.length;n++){l.append(c[n])}}}if(e.className){Object.keys(e.className).forEach(function(t){var n=e.className[t][t];l.addClass(n);r(e.className[t],t,function(e){if(e!=n){l.removeClass(n);l.addClass(e);n=e}},l)})}for(n in e){if(["classes","contains","tag","forEach","className"].indexOf(n)===-1){var f=e[n];if(f instanceof Object){var d=Object.keys(f);for(var v=0;v<d.length;v++){var m=d[v];r(f[m],m,n,l)}}else{l.setAttr(n,e[n])}}}}var s={};var l={};function c(e,t){var n=0;if(s.hasOwnProperty(e)){var r=s[e];s[e]=[];r.forEach(function(e){setTimeout(function(){e(t)},0)})}if(l.hasOwnProperty(e)){l[e].forEach(function(e){setTimeout(function(){e(t)},0)})}}function u(e,t){if(!l.hasOwnProperty(e)){l[e]=[]}l[e].push(t);return{terminate:function(){var n=l[e].indexOf(t);if(n>=0){l[e].splice(n,1)}}}}function f(e,t){if(!s.hasOwnProperty(e)){s[e]=[]}s[e].push(t);return{terminate:function(){var n=s[e].indexOf(t);if(n>=0){s[e].splice(n,1)}}}}function d(){s={};l={}}var p={};var v=["model","view","controller"];v.forEach(function(e){p[e]={__pjsDefine:function(t,n){if(p[e].hasOwnProperty(t)){console.log("Duplicate definition found for "+e,t);return}p[e][t]=n},__pjsCreate:function(t){if(!p[e].hasOwnProperty(t)){console.error("Dynamic script loader failed to find "+e+":",t);return null}var n=Array.prototype.slice.call(arguments);n.shift();var r=p[e][t];if(e=="view"){var o=new i({classes:["view."+t]});r.apply(o,n);return o}n.unshift(null);return new(r.bind.apply(r,n))}}});var m=16;function h(e,t){if(e.substring(0,1)=="@"){return{style:{}}}for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];for(var o=0;o<r.cssRules.length;o++){if(r.cssRules[o].selectorText==e){return r.cssRules[o]}}}if(t){console.error("Failed to create rule for",e);return{style:{}}}if(document.styleSheets[0].addRule){document.styleSheets[0].addRule(e,"dummy: default")}else{document.styleSheets[0].insertRule(e+"{ dummy: default }",document.styleSheets[0].length)}return h(e,true)}function g(e,t,n){var r=n.split(" ");for(var o=0;o<r.length;o++){var a=r[o];if((""+a).match("^[0-9]{1,}px")){a=""+a;a=parseInt(a.substring(0,a.length-2),10);a=a/m;a=a+"em";r[o]=a}}n=r.join(" ");e.style[t]=n}function y(e){return e/m}function w(e){var t;for(var n in e){if(n.substring(0,1)=="@"||n.substring(0,2)=="::"){var r=document.createElement("style");r.type="text/css";document.querySelectorAll("head")[0].appendChild(r);var o="";for(t in e[n]){o+=t+": "+e[n][t]+"; "}r.appendChild(document.createTextNode(n+" { "+o+" }"))}else{var a=h(n);for(t in e[n]){g(a,t,e[n][t])}}}}function O(t,n,r){var o=document.createElement("script");o.src=e.location.origin+e.location.pathname+t+"/"+n+".js";console.log("Loading ["+o.src+"]");o.onload=function(e){setTimeout(function(){r()},0)};o.onerror=function(e){console.error("Failed to load",t,n,o.src);r(e)};document.querySelectorAll("head")[0].appendChild(o)}function b(e,t,n,r){if(e.hasOwnProperty(n))return r();O(t,n,function(o){if(o||!e[n])return r(o);var a=e[n].toString();var i=[];["model","view","controller","service"].forEach(function(e){var t=a.split("pjs."+e+"(");for(var n=1;n<t.length;n++){t[n]=t[n].split(")")[0].split(",")[0].replace(/["' ]/g,"");i.push({container:p[e],type:e.substring(0,1).toUpperCase()+e.substring(1),name:t[n]})}});var s=a.split(/usingView: ?["'](.*?)["']/g);for(var l=1;l<s.length;l+=2){i.push({container:p.view,type:t.substring(0,1).toUpperCase()+t.substring(1),name:s[l]})}if(i.length===0)return r();var c=0;i.forEach(function(e){b(e.container,e.type,e.name,function(e){if(e)return r(e);c++;if(c==i.length){return r()}})})})}var j=[];function E(e,t){if(!p.controller[t]){console.error("Controller",t,"was not loaded, can't route");return}var n=new pjs.element;n.dom=e;n.clear();d();var r=Array.prototype.slice.call(arguments);r[0]=t;r[1]=n;p.controller.__pjsCreate.apply({},r);return this}function N(e,t,n){console.log("Routing to [/"+t+"]");var r,o=function(){};for(var a in j){r=t.match(j[a].path);if(r){r=Array.prototype.slice.call(r);r[0]=j[a].controller;var i=_(t);if(i){r=r.concat(i)}r.push(n||o);r.unshift(e);E.apply({},r);return}}r=[e,j[Object.keys(j)[0]].controller,n||o];E.apply({},r)}function C(e,t){sessionStorage.setItem(e,JSON.stringify(t))}function P(e){var t=null;try{t=JSON.parse(sessionStorage.getItem(e))}catch(n){}return t}function _(e){return history.state}function A(t,n){history.pushState(n,e.title,"#"+t)}function L(t){var n=t.split("*");args=Array.prototype.slice.call(arguments);args.shift();var r="";for(var o=0;o<n.length;o++){r+=n[o];if(o<n.length-1&&args.length>0){r+=args.shift()}}A(r,args);e.location.hash=r;e.onpopstate()}function k(e){if(j.length===0)e();var t=0;j.forEach(function(n){b(p.controller,"Controller",n.controller,function(r){if(r){console.error("Failed to load all dependencies for",n,r)}t++;if(t==j.length)e()})})}function S(t,n,r){t.innerHTML="";console.log("Initialising...");e.onerror=r;var o=false;e.onpopstate=function(n){if(o){N(t,e.location.hash.substring(1))}o=true};for(var a in n){n[a].path=new RegExp("^"+n[a].path.replace(/\//g,"\\/").replace(/\*/g,"([^\\/]{0,})"));j.push(n[a])}k(function(n){console.log("Finished Loading Dependencies");N(t,e.location.hash.substring(1))})}e.pjs={defineRoutes:S,defineModel:p.model.__pjsDefine,defineView:p.view.__pjsDefine,defineController:p.controller.__pjsDefine,element:i,model:p.model.__pjsCreate,view:p.view.__pjsCreate,controller:p.controller.__pjsCreate,eventWaitAll:u,eventWaitOnce:f,triggerEvent:c,route:L}})(window);