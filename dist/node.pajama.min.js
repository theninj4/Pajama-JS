document={};var elemCount=0;document.createElement=function(e){var t=[];var n=[];var r={};var i={tagName:e,elemCount:elemCount++,classList:{add:function(e){n.push(e)},remove:function(e){for(var t=0;t<n.length;t++){if(n[t]==e){n.splice(t,1)}}},contains:function(e){for(var t=0;t<n.length;t++){if(n[t]==e){return true}}return false}},addEventListener:function(e,t){if(!r[e])r[e]=[];r[e].push(t)},removeEventListener:function(e,t){if(!r[e])return;var n=r[e].indexOf(t);if(n>=0){r[e].splice(n,1)}},appendChild:function(e){t.push(e);e.parentNode=i;this.firstChild=t[0]},insertBefore:function(e,n){var r=t.indexOf(n);e.parentNode=this;if(r<0){t.unshift(e);return}t.splice(r,0,e);this.firstChild=t[0]},removeChild:function(e){for(var n=0;n<t.length;n++){if(t[n]==e){t.splice(n,1);e.parentNode=null;break}}this.firstChild=t[0]},childNodes:t,dispatchEvent:function(e){if(r[e.type]){for(var t=0;t<r[e.type].length;t++){r[e.type][t].call({},{})}}if(this.parentNode){this.parentNode.dispatchEvent(e)}},parentNode:null,firstChild:null,setAttribute:function(e,t){this[e]=t}};return i};document.createEvent=function(){return{type:"",initEvent:function(e,t,n){this.type=e}}};function PjsDataBindingRequest(e){for(var t in e){this[t]=e[t]}}function PjsBindProperty(e,t,n,r){if(e[t]==undefined){e[t]=""}if(e[t]instanceof Function){var i=function(n){e[t].call(e,n)};r.garbage.push(function(){r.removeEvent(n,i)});r.addEvent(n,i);return}if(!Object.getOwnPropertyDescriptor(e,t).hasOwnProperty("get")){var a=e[t];var o=[];var l;Object.defineProperty(e,t,{get:function(){return a},set:function(n){if(n instanceof PjsDataBindingRequest){l=n.element;var i=function(){n.element.setAttr(n.attr,a)};var s=function(r){if(n.element.getAttr(n.attr)!=a){e[t]=n.element.getAttr(n.attr)}};if(n.attr instanceof Function){i=n.attr;s=function(){}}r.garbage.push(function(){l=null;var r=o.indexOf(i);if(r>=0){o.splice(r,1)}n.element.removeEvent("change",s);n.element.removeEvent("keyup",s);Object.defineProperty(e,t,{value:a,writable:true})});o.push(i);n.element.addEvent("change",s);n.element.addEvent("keyup",s);n.element.setAttr(n.attr,a)}else{a=n;for(var u=0;u<o.length;u++){o[u].call(r,a)}}},enumerable:true})}e[t]=new PjsDataBindingRequest({element:r,attr:n})}function PjsBindArray(e,t,n,r){if(!e.hasOwnProperty(t)){e[t]=[]}if(!Object.getOwnPropertyDescriptor(e,t).hasOwnProperty("get")){var i=e[t];var a=[];Object.defineProperty(e,t,{get:function(){var n=i.concat([]);Object.defineProperty(n,"pop",{value:function(){var e=i.pop();for(var t=0;t<a.length;t++){var n=a[t].element.getNodes();n[n.length-1].remove()}return e}});Object.defineProperty(n,"push",{value:function(){var e=i.push.apply(i,Array.prototype.slice.call(arguments));for(var t=0;t<a.length;t++){var n=a[t];n.element.append(n.func.call({},arguments[0]))}return e}});Object.defineProperty(n,"reverse",{value:function(){var n=i.reverse();e[t]=i;return n}});Object.defineProperty(n,"shift",{value:function(){var e=i.shift();for(var t=0;t<a.length;t++){var n=a[t].element.getNodes();n[0].remove()}return e}});Object.defineProperty(n,"sort",{value:function(){var n=i.sort.apply(i,Array.prototype.slice.call(arguments));e[t]=i;return n}});Object.defineProperty(n,"splice",{value:function(){var n=i.splice.apply(i,Array.prototype.slice.call(arguments));e[t]=i;return n}});Object.defineProperty(n,"unshift",{value:function(){var e=i.unshift.apply(i,Array.prototype.slice.call(arguments));for(var t=0;t<a.length;t++){var n=a[t];n.element.prepend(n.func.call({},arguments[0]))}return e}});return n},set:function(n){if(n instanceof PjsDataBindingRequest){a.push({element:n.element,func:n.func})}else{i=n}for(var r=0;r<a.length;r++){var o=a[r];o.element.clear();for(var l in i){o.element.append(o.func.call({},e[t][l]))}}},enumerable:true})}e[t]=new PjsDataBindingRequest({element:n,func:r})}var elemCount=0;function PjsElement(e){if(!e)e={};if(!e.tag)e.tag="div";var t;var n=document.createElement(e.tag);var r=this;r.dom=n;r.eventList=[];r.garbage=[];n._view=r;r.uuid=elemCount++;r.prepend=function(e){var t=e;if(!(t instanceof Array))t=Array.prototype.slice.call(arguments);for(var n=0;n<t.length;n++){var i=t[n];if(i instanceof PjsElement){r.dom.insertBefore(i.dom,r.dom.firstChild);if(require)r.fireEvent("PjsChange",{type:"prepend",parent:r.uuid,markup:i.toMarkup(true)})}else{r.prepend(new PjsElement(i))}}};r.append=function(e){var t=e;if(!(t instanceof Array))t=Array.prototype.slice.call(arguments);for(var n=0;n<t.length;n++){var i=t[n];if(i instanceof PjsElement){r.dom.appendChild(i.dom);if(require)r.fireEvent("PjsChange",{type:"append",parent:r.uuid,markup:i.toMarkup(true)})}else{r.append(new PjsElement(i))}}};r.remove=function(e){if(require&&!e){r.fireEvent("PjsChange",{type:"remove",parent:r.dom.parentNode._view.uuid,child:r.uuid})}r.dom.parentNode.removeChild(r.dom);r.recycle()};r.recycle=function(){var e,t=r.getNodes();for(e=0;e<t.length;e++){t[e].recycle()}for(e=0;e<r.garbage.length;e++){r.garbage[e]()}};r.addClass=function(e){if(e!==""){r.dom.className=r.dom.className||"";r.dom.className+=" "+e}};r.removeClass=function(e){if(e!==""){r.dom.className=(" "+r.dom.className+" ").replace(" "+e+" ","")}};r.hasClass=function(e){return(" "+r.dom.className+" ").indexOf(" "+e+" ")!=-1};r.setAttr=function(e,t){if(typeof e=="string"&&r.dom[e]!=t){r.dom[e]=t;r.dom.setAttribute(e,t);if(require)r.fireEvent("PjsChange",{type:"attr",id:r.uuid,attr:e,value:t})}};r.getAttr=function(e){return r.dom[e]};r.addEvent=function(e,t){r.dom.addEventListener(e,t);if(r.eventList.indexOf(e)==-1)r.eventList.push(e)};r.removeEvent=function(e,t){r.dom.removeEventListener(e,t)};r.setValue=function(e){if(["input","select"].indexOf(r.dom.tagName.toLowerCase())!=-1){r.dom.value=e}else{r.dom.innerHTML=e}};r.getValue=function(){return r.dom.value||r.dom.innerHTML};r.clear=function(){var e=r.dom.childNodes.length;for(var t=0;t<e;t++){r.dom.childNodes[0]._view.remove(true)}if(require)r.fireEvent("PjsChange",{type:"clear",parent:r.uuid});return r};r.fireEvent=function(e,t){var n=document.createEvent("HTMLEvents");n.initEvent(e,true,true);n.detail=t;r.dom.dispatchEvent(n);return r};r.getNodes=function(){var e=[];for(var t=0;t<r.dom.childNodes.length;t++){var n=r.dom.childNodes[t];if(n._view){e.push(n._view)}else{var i=new PjsElement;i.dom=n;e.push(i)}}return e};r.getByUuid=function(e){if(r.uuid==e)return r;for(var t=0;t<r.dom.childNodes.length;t++){var n=r.dom.childNodes[t]._view.getByUuid(e);if(n)return n}return null};r.toMarkup=function(e){var t="<"+r.dom.tagName;for(var n in r.dom){if(["tagName","elemCount","classList","addEventListener","appendChild","removeChild","childNodes","dispatchEvent","_view","parentNode"].indexOf(n)<0){if(typeof r.dom[n]=="string"||typeof r.dom[n]=="number"){t+=" "+n+'="'+r.dom[n]+'"'}}}if(e){t+=" id='"+r.uuid+"'";for(var i in r.eventList){var a=r.eventList[i];t+=" on"+a+"=\"dispatch('"+r.uuid+"', '"+a+"', event)\" "}}t+=">";if(r.dom.innerHTML){t+=r.dom.innerHTML}for(var o in r.dom.childNodes){t+=r.dom.childNodes[o]._view.toMarkup(e)}return t+"</"+r.dom.tagName+">"};if(e.classes){for(t=0;t<e.classes.length;t++){r.addClass(e.classes[t])}}if(e.contains){var i=e.contains;if(i instanceof Object&&Object.keys(i).length==1&&e.forEach){var a=Object.keys(i)[0];PjsBindArray(i[a],a,r,e.forEach)}else if(i instanceof Object&&Object.keys(i).length==1&&e.usingView){var a=Object.keys(i)[0];PjsBindArray(i[a],a,r,function(t){mvc.view[e.usingView].apply(r,[t])})}else{if(!(i instanceof Array))i=[i];for(t=0;t<i.length;t++){r.append(i[t])}}}if(e.className){Object.keys(e.className).forEach(function(t){var n=e.className[t][t];r.addClass(n);PjsBindProperty(e.className[t],t,function(e){if(e!=n){r.removeClass(n);r.addClass(e);n=e}},r)})}for(t in e){if(["classes","contains","tag","forEach","className"].indexOf(t)===-1){var o=e[t];if(o instanceof Object){var l=Object.keys(o);for(var s=0;s<l.length;s++){var u=l[s];PjsBindProperty(o[u],u,t,r)}}else{r.setAttr(t,e[t])}}}}var tempEventQueue={};var longEventQueue={};function triggerEvent(e,t){var n=0;if(tempEventQueue.hasOwnProperty(e)){var r=tempEventQueue[e];tempEventQueue[e]=[];r.forEach(function(e){setTimeout(function(){e(t)},0)})}if(longEventQueue.hasOwnProperty(e)){longEventQueue[e].forEach(function(e){setTimeout(function(){e(t)},0)})}}function eventWaitAll(e,t){if(!longEventQueue.hasOwnProperty(e)){longEventQueue[e]=[]}longEventQueue[e].push(t);return{terminate:function(){var n=longEventQueue[e].indexOf(t);if(n>=0){longEventQueue[e].splice(n,1)}}}}function eventWaitOnce(e,t){if(!tempEventQueue.hasOwnProperty(e)){tempEventQueue[e]=[]}tempEventQueue[e].push(t);return{terminate:function(){var n=tempEventQueue[e].indexOf(t);if(n>=0){tempEventQueue[e].splice(n,1)}}}}function clearAllEvents(){tempEventQueue={};longEventQueue={}}var mvc={};var bits=["model","view","controller"];bits.forEach(function(e){mvc[e]={__pjsDefine:function(t,n){if(mvc[e].hasOwnProperty(t)){console.log("Duplicate definition found for "+e,t);return}mvc[e][t]=n},__pjsCreate:function(t){if(!mvc[e].hasOwnProperty(t)){console.error("Dynamic script loader failed to find "+e+":",t);return null}var n=Array.prototype.slice.call(arguments);n.shift();var r=mvc[e][t];if(e=="view"){var i=new PjsElement({classes:["view."+t]});r.apply(i,n);return i}n.unshift(null);return new(r.bind.apply(r,n))}}});var bootstrapper=function(){var e=io.connect("http://---");e.on("fullPage",function(e){document.body.innerHTML=e});e.on("updateDom",function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.type=="attr"){var r=document.getElementById(n.id);if(r){r[n.attr]=n.value}}else if(n.type=="append"){var i=document.createElement("div");i.innerHTML=n.markup;var r=document.getElementById(n.parent);if(r){r.appendChild(i.firstChild)}}else if(n.type=="prepend"){var i=document.createElement("div");i.innerHTML=n.markup;var r=document.getElementById(n.parent);if(r){r.insertBefore(i.firstChild,r.firstChild)}}else if(n.type=="remove"){var a=document.getElementById(n.parent);var o=document.getElementById(n.child);if(a){a.removeChild(o)}}else if(n.type=="clear"){var a=document.getElementById(n.parent);if(a){a.innerHTML=""}}}});e.on("loading",function(){document.body.innerHTML=""});e.emit("pageLoad",window.location.pathname+window.location.search);function t(t,n,r){var i={};for(var a in r){if(typeof r[a]=="string"||typeof r[a]=="number"){i[a]=r[a]}}e.emit("action",{id:t,type:n,value:r.srcElement.value,content:r.srcElement.innerHTML})}};function startServer(e,t){var n=e.host+":"+e.port;if(!e.nativeApp){console.log("Starting pjs server on",n)}for(var r in t){t[r].url=new RegExp("^"+t[r].url.replace(/\//g,"\\/").replace(/\*/g,"([^\\/]{0,})"))}var i=bootstrapper.toString().replace("---",n);i=i.substring(13,i.length-1);var a=require("http").createServer(function(e,t){t.writeHead(200);t.end('<html><head><script src="/socket.io/socket.io.js"></script><script>'+i+"</script></head><body></body></html>")});var o=require("socket.io").listen(a,{log:false});o.set("transports",["websocket","htmlfile","xhr-polling","jsonp-polling"]);o.enable("browser client minification");o.enable("browser client etag");o.enable("browser client gzip");a.listen(e.port);var l=0;o.sockets.on("connection",function(n){if(e.nativeApp&&l){process.exit(0)}l++;var i=new PjsElement;i.dom=document.createElement("div");var a;var o=[];i.dom.parentNode={dispatchEvent:function(e){if(e.type=="PjsChange"){o.push(e.detail);if(a)clearTimeout(a);a=setTimeout(function(){n.emit("updateDom",o);o=[]},100)}}};n.on("pageLoad",function(e){var a=t[t.length-1].controller;for(r in t){if(e.match(t[r].url)){a=t[r].controller;break}}i.clear();n.emit("fullPage",i.toMarkup(true));var o={headers:n.handshake.headers,address:n.handshake.address,url:e};a.call({},i,o)});n.on("sync",function(){n.emit("fullPage",i.toMarkup(true))});n.on("action",function(e){if(!e||!e.id||!e.type||!(e.value||e.content)){return}var t=i.getByUuid(e.id);if(!t){console.log("--------");console.log("Couldn't perform action:",e);console.log(i.toMarkup(true));return}if(t.tag!="button"){t.setValue(e.value||e.content)}t.fireEvent(e.type)});n.on("disconnect",function(){i.clear();i=null;if(e.nativeApp){process.exit(0)}})})}function nativeApp(e,t){startServer({host:"localhost",port:46240,nativeApp:true},[{url:"/nativeApp",controller:e.main}]);var n=["--app=http://localhost:46240/nativeApp","--app-window-size="+(e.width||700)+","+(e.height||500),"--user-data-dir=./tmp"];require("child_process").spawn("google-chrome",n)}module.exports={startServer:startServer,nativeApp:nativeApp,defineModel:mvc.model.__pjsDefine,defineView:mvc.view.__pjsDefine,defineController:mvc.controller.__pjsDefine,element:PjsElement,model:mvc.model.__pjsCreate,view:mvc.view.__pjsCreate,controller:mvc.controller.__pjsCreate,eventWaitAll:eventWaitAll,eventWaitOnce:eventWaitOnce,triggerEvent:triggerEvent};